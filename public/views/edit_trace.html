<!--
=========================================================
ITRACE
=========================================================

Coded by Adrian Neil Asence

=========================================================
The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  
  <link rel="icon" type="image/png" href="../assets/img/icons/icon-72x72.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    ITRACE
  </title>
  <meta content='width=device-width, initial-scale=1.0, shrink-to-fit=no' name='viewport' />
  <meta content='yes' name='apple-mobile-web-app-capable'/>
  <meta content='yes' name='mobile-web-app-capable'/>
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <!-- CSS Files -->
  <link href="../assets/css/material-dashboard.css?v=2.1.2" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="../assets/css/main.css" rel="stylesheet" />
  
  <link rel="manifest" href="../manifest.json">

  <!-- ios support -->
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/icons/icon-96x96.png">
  <meta name="apple-mobile-web-app-status-bar" content="#6c0e7f">
  <meta name="theme-color" content="#9c27b0">


</head>

<body class="" oncontextmenu="return false">
  <div class="wrapper">
   
    <div class="main-panel">
      <!-- Navbar -->
      
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="javascript:void(0);">Edit Trace</a>
          </div>
          <a class="btn btn-link btn-fab btn-round" href="traces.html"><i class="material-icons">close</i>          
          </a>
          <div class="collapse navbar-collapse justify-content-end">
            <form class="navbar-form">
              <div class="input-group no-border">
                <input type="text" value="" class="form-control" placeholder="Search...">
                <button type="submit" class="btn btn-white btn-round btn-just-icon">
                  <i class="material-icons">search</i>
                  <div class="ripple-container"></div>
                </button>
              </div>
            </form>
            <ul class="navbar-nav">
              
            </ul>
          </div>
        </div>
        <hr/>
      </nav>
      <!-- End Navbar -->
      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-12">

              <form id="edit_record_form">
                <div id="edit_message">
    
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="label-floating">First Name</label>
                      <input type="text" class="form-control" id="edit_firstname" autocomplete="off">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="label-floating">Last Name</label>
                      <input type="text" class="form-control mt-4" id="edit_lastname" autocomplete="off">
                    </div>
                  </div>
                </div>

                <div class="row">                                     
                  <div class="col-md-4">
                    <div class="form-group">
                      <label class="label-floating">Email address</label>
                      <input type="email" class="form-control mt-4" id="edit_emailadd" autocomplete="off">
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label class="label-floating">Contact Number</label>
                      <input type="number" class="form-control mt-4" id="edit_contactnum" autocomplete="off">
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-sm-12">
                    <div class="form-group">
                      <label class="label-floating">Address</label>
                      <input type="text" class="form-control mt-4" id="edit_address" autocomplete="off">
                      
                      <button class="btn btn-info btn-sm col-sm-6" id="get_location_btn" onclick="get_current_location();">
                        Get current Location
                      </button>
                      
                      <button class="btn btn-warning btn-sm col-sm-6" id="set_location_btn" onclick="set_location();">
                        Set the Location
                      </button>

                      <div id="set_trace_map" style="height: 250px">

                      </div>
                    </div>
                  </div>                                           
                </div>

                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="add_type">Status</label>
                      <select class="form-control" data-style="btn btn-link" id="edit_type">
                        <option value="Unknown">Unknown</option>
                        <option value="Recovery">Recovery</option>
                        <option value="Infected">Infected</option>
                        <option value="Death">Death</option>
                        <option value="Isolated">Isolated</option>
                      </select>
                    </div>
                  </div>
                </div>

                <button id="edit_trace_btn" type="button" class="btn btn-success btn-block mb-3 mt-4">Save Record</button>

                <div class="clearfix"></div>
              </form>
    
            </div>
          </div>

          
        </div>
      </div>

    </div>
  </div>
 
  <!--   Core JS Files   -->
  <script src="../assets/js/core/jquery.min.js"></script>
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap-material-design.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <!-- Plugin for the momentJs  -->
  <script src="../assets/js/plugins/moment.min.js"></script>
  <!--  Plugin for Sweet Alert -->
  <script src="../assets/js/plugins/sweetalert2.js"></script>
  <!-- Forms Validations Plugin -->
  <script src="../assets/js/plugins/jquery.validate.min.js"></script>
  <!-- Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
  <script src="../assets/js/plugins/jquery.bootstrap-wizard.js"></script>
  <!--	Plugin for Select, full documentation here: http://silviomoreto.github.io/bootstrap-select -->
  <script src="../assets/js/plugins/bootstrap-selectpicker.js"></script>
  <!--  Plugin for the DateTimePicker, full documentation here: https://eonasdan.github.io/bootstrap-datetimepicker/ -->
  <script src="../assets/js/plugins/bootstrap-datetimepicker.min.js"></script>
  <!--  DataTables.net Plugin, full documentation here: https://datatables.net/  -->
  <script src="../assets/js/plugins/jquery.dataTables.min.js"></script>
  <!--	Plugin for Tags, full documentation here: https://github.com/bootstrap-tagsinput/bootstrap-tagsinputs  -->
  <script src="../assets/js/plugins/bootstrap-tagsinput.js"></script>
  <!-- Plugin for Fileupload, full documentation here: http://www.jasny.net/bootstrap/javascript/#fileinput -->
  <script src="../assets/js/plugins/jasny-bootstrap.min.js"></script>
  <!--  Full Calendar Plugin, full documentation here: https://github.com/fullcalendar/fullcalendar    -->
  <script src="../assets/js/plugins/fullcalendar.min.js"></script>
  <!-- Vector Map plugin, full documentation here: http://jvectormap.com/documentation/ -->
  <script src="../assets/js/plugins/jquery-jvectormap.js"></script>
  <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
  <script src="../assets/js/plugins/nouislider.min.js"></script>
  <!-- Include a polyfill for ES6 Promises (optional) for IE11, UC Browser and Android browser support SweetAlert -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.js"></script>
  <!-- Library for adding dinamically elements -->
  <script src="../assets/js/plugins/arrive.min.js"></script>
  <!--  Google Maps Plugin    -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCL0GSMCN9vKb6AUulcxHsLEj3JQHVJS9M"></script>
  <!-- Chartist JS -->
  <script src="../assets/js/plugins/chartist.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="../assets/js/plugins/bootstrap-notify.js"></script>
  <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../assets/js/material-dashboard.js?v=2.1.2" type="text/javascript"></script>
  <!-- Material Dashboard DEMO methods, don't include it in your project! -->
  
  <script src="../assets/js/main.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-firestore.js"></script>
  <script src="../assets/js/app.js"></script>
 
  <script src="../assets/js/fstore.js"></script>

  <script>
    
    $(document).ready(function() {
        
        localStorage.removeItem("lat");
        localStorage.removeItem("lng");
        $('#set_trace_map').hide();
      // Javascript method's body can be found in assets/js/demos.js
      // add_trace.initSetTraceMap();
       
      
    });

    let get_url = window.location.href
    let _id = get_url.split("=").pop();


    get_trace_data = db.collection('trace_record').doc(_id);
    get_trace_data.get().then((doc) =>{
      console.log(localStorage.getItem('session_name'))
      console.log(doc.data().addedby)
        if(localStorage.getItem('session_name') != doc.data().addedby){        
          let edit_message_alert = `
            <div class="alert alert-warning" role="alert">
              This record is not the one you added. You cannot edit this data
            </div>
          `
          $('#edit_message').html(edit_message_alert);
          $('#edit_firstname').attr('disabled', 'true');
          $('#edit_lastname').attr('disabled', 'true');
          $('#edit_emailadd').attr('disabled', 'true');
          $('#edit_contactnum').attr('disabled', 'true');
          $('#edit_address').attr('disabled', 'true');
          $('#edit_type').attr('disabled', 'true');
          $('#get_location_btn').attr('disabled', 'true');
          $('#set_location_btn').attr('disabled', 'true');
          $('#edit_trace_btn').attr('disabled', 'true');

        }
        $('#edit_firstname').val(doc.data().firstname);
        $('#edit_lastname').val(doc.data().lastname);
        $('#edit_emailadd').val(doc.data().email_address);
        $('#edit_contactnum').val(doc.data().contact_num);
        $('#edit_address').val(doc.data().address);
        $('#edit_type').val(doc.data().type);
        // $('#edit_firstname').val(doc.data().firstname);
        let trace_record_lat = doc.data().geo_location.latitude;         
        let trace_record_lng = doc.data().geo_location.longitude;
        localStorage.setItem('trace_record_lat', trace_record_lat)
        localStorage.setItem('trace_record_lng', trace_record_lng)
        initSetTraceMap();
    })    





    ///////////////// current locator
    $('#add_address').keyup(function(){
      if(this.value == ''){
        $('#get_location_btn').addClass('btn-info').removeClass('btn-warning btn-success btn-danger').html('Get Current Location');        
      }
    })
    
    function get_current_location() {     
      const geocoder = new google.maps.Geocoder();     
      event.preventDefault();
      $('#set_location_btn').slideUp();
      // current_locator();
      $('#get_location_btn').addClass('btn-warning').removeClass('btn-info').html('Locating');
      if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                const pos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                };                              
                const input = pos.lat + ", "+ pos.lng;                
                const latlngStr = input.split(",", 2);
                const latlng = {
                  lat: parseFloat(latlngStr[0]),
                  lng: parseFloat(latlngStr[1]),
                };
           
                geocoder.geocode({ location: latlng }, (results, status) => {
                  if (status === "OK") {                    
                    if (results[0]) {                      
                      document.getElementById("add_address").focus();
                      document.getElementById("add_address").value = results[0].formatted_address
                      localStorage.setItem("lat", pos.lat)
                      localStorage.setItem("lng", pos.lng)
                      $('#get_location_btn').addClass('btn-success').removeClass('btn-warning').html('Location Found');                
                      $('#set_location_btn').slideDown();      
                      // document.getElementById("set_trace_map").focus();
                    } else {
                      window.alert("No results found");
                    }
                  } else {
                    window.alert("Geocoder failed due to: " + status);
                    $('#get_location_btn').addClass('btn-danger').removeClass('btn-warning').html('Failed');
                  }
                });

              },
              () => {
                handleLocationError(true);
              }
            );
          } else {
            // Browser doesn't support Geolocation
            handleLocationError(false);
          }
          
      function handleLocationError(browserHasGeolocation) {
        if(browserHasGeolocation){
          console.log("The Geolocation service failed.");
        }else{
          console.log("Your Device doesn't support geolocation..");
        }
      }     
    }
    /////////////////////// manual locator
    function set_location() {
      event.preventDefault();
      if($('#set_location_btn').hasClass('btn-warning')){
        $('#set_trace_map').slideDown();
        $('#get_location_btn').slideUp();
        $('#set_location_btn').removeClass('btn-warning').addClass('btn-success').html('Confirm');
        $('#get_location_btn').addClass('btn-info').removeClass('btn-warning btn-success btn-danger').html('Get Current Location'); 
         
      }else{
        $('#set_trace_map').slideUp();
        $('#get_location_btn').slideDown();
        $('#set_location_btn').addClass('btn-warning').removeClass('btn-success').html('Set the Location');
        
      }

      
    }
    function initSetTraceMap(){
      const geocoder = new google.maps.Geocoder();
      const infowindow = new google.maps.InfoWindow();
      let markers = [];
      const center = new google.maps.LatLng(localStorage.getItem('trace_record_lat'), localStorage.getItem('trace_record_lng'));
      let mapOptions = {
        zoom: 15,
        center: center,
        scrollwheel: false, //we disable de scroll over the map, it is a really annoing when you scroll through page
        disableDefaultUI: true,
        gestureHandling: "greedy",
        // streetViewControl: true,
        styles: [{
          "featureType": "water",
          "stylers": [{
            "saturation": 43
          }, {
            "lightness": -11
          }, {
            "hue": "#0088ff"
          }]
        }, {
          "featureType": "road",
          "elementType": "geometry.fill",
          "stylers": [{
            "hue": "#ff0000"
          }, {
            "saturation": -100
          }, {
            "lightness": 99
          }]
        }, {
          "featureType": "road",
          "elementType": "geometry.stroke",
          "stylers": [{
            "color": "#808080"
          }, {
            "lightness": 54
          }]
        }, {
          "featureType": "landscape.man_made",
          "elementType": "geometry.fill",
          "stylers": [{
            "color": "#ece2d9"
          }]
        }, {
          "featureType": "poi.park",
          "elementType": "geometry.fill",
          "stylers": [{
            "color": "#ccdca1"
          }]
        }, {
          "featureType": "road",
          "elementType": "labels.text.fill",
          "stylers": [{
            "color": "#767676"
          }]
        }, {
          "featureType": "road",
          "elementType": "labels.text.stroke",
          "stylers": [{
            "color": "#ffffff"
          }]
        }, {
          "featureType": "poi",
          "stylers": [{
            "visibility": "off"
          }]
        }, {
          "featureType": "landscape.natural",
          "elementType": "geometry.fill",
          "stylers": [{
            "visibility": "on"
          }, {
            "color": "#b8cb93"
          }]
        }, {
          "featureType": "poi.park",
          "stylers": [{
            "visibility": "on"
          }]
        }, {
          "featureType": "poi.sports_complex",
          "stylers": [{
            "visibility": "on"
          }]
        }, {
          "featureType": "poi.medical",
          "stylers": [{
            "visibility": "on"
          }]
        }, {
          "featureType": "poi.business",
          "stylers": [{
            "visibility": "simplified"
          }]
        }]

      };
      var map = new google.maps.Map(document.getElementById("set_trace_map"), mapOptions);

      let default_marker = new google.maps.LatLng(localStorage.getItem('trace_record_lat'), localStorage.getItem('trace_record_lng'));      
      
      map.addListener("click", (event) =>{
        add_selected_marker(event.latLng);
      });
      add_default_marker(default_marker);

      function add_selected_marker(location) {      
        deleteMarkers();
           
        const marker = new google.maps.Marker({
          position: location,
          map: map,
        });              
        
        markers.push(marker)
        const position_select = marker.position.lat() + ", " + marker.position.lng();
        // const geolocation = new firebase.firestore.GeoPoint(marker.position.lat(), marker.position.lng());
        // console.log(geolocation);
        // geocodeLatLng(geocoder, map, infowindow, position_select);
        const input = position_select;
        const latlngStr = input.split(",", 2);
        const latlng = {
          lat: parseFloat(latlngStr[0]),
          lng: parseFloat(latlngStr[1]),
        };
        geocoder.geocode({ location: latlng }, (results, status) => {
          if (status === "OK") {
            
            if (results[0]) {
              // map.setZoom(11);          
              infowindow.setContent(results[0].formatted_address);
              infowindow.open(map, marker);
              document.getElementById("edit_address").focus();
              document.getElementById("edit_address").value = results[0].formatted_address
              localStorage.setItem("lat", marker.position.lat())
              localStorage.setItem("lng", marker.position.lng())
              document.getElementById("set_trace_map").focus();
            } else {
              window.alert("No results found");
            }
          } else {
            window.alert("Geocoder failed due to: " + status);
          }
        });
        
    
      }

      function add_default_marker(location) {
        const marker = new google.maps.Marker({
          position: location,
          map: map,
        });              
        markers.push(marker)
        const position_r = {
          lat: marker.position.lat(),
          lng: marker.position.lng()
        }
        // console.log(position_r);
    
      }

      function setMapOnAll(map) {
        for (let i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
        }
      }

      function deleteMarkers() {
        clearMarkers();
        markers = [];
      }

      function clearMarkers() {
        setMapOnAll(null);
      }
    }
    
    const edit_record_form = document.querySelector('#edit_record_form');
    document.getElementById("edit_trace_btn").addEventListener('click', event =>{
        event.preventDefault()
        const geolocation = new firebase.firestore.GeoPoint(localStorage.getItem('lat'), localStorage.getItem('lng'));
        const edit_record_form_data = {
            firstname : edit_record_form.edit_firstname.value,
            lastname : edit_record_form.edit_lastname.value,
            email_address : edit_record_form.edit_emailadd.value,
            contact_num : edit_record_form.edit_contactnum.value,
            address : edit_record_form.edit_address.value,            
            type: edit_record_form.edit_type.value,
            // addedby : localStorage.getItem("session_name"),            
            // time_added : firebase.firestore.Timestamp.fromDate(new Date()), 
            geo_location: geolocation
        };
        console.log(edit_record_form_data)
    
        db.collection('trace_record').doc(_id).update(edit_record_form_data)
        .then(() => swalfire('edit_trace_success'))
        .catch(error => console.log(error));

        // edit_record_form.reset();

    })

  </script>
   <script src="../assets/js/swalfire.js"></script>

  
  
</body>

</html>