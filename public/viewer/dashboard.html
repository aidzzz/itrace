<!--
=========================================================
ITRACE APP
=========================================================
Coded by Adrian Neil Asence
=========================================================
The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. -->
<!DOCTYPE html>
<html lang="en">

<head>
  <script type="text/javascript">
  </script>
  <meta charset="utf-8" />
  
  <link rel="icon" type="image/png" href="../assets/img/icons/icon-72x72.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    ITRACE
  </title>
  <meta content='width=device-width, initial-scale=1.0, shrink-to-fit=no' name='viewport' />
  <meta content='yes' name='apple-mobile-web-app-capable'/>
  <meta content='yes' name='mobile-web-app-capable'/>
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <!-- CSS Files -->
  <link href="../assets/css/material-dashboard.css?v=2.1.2" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="../assets/css/main.css" rel="stylesheet" />
  
  <link rel="manifest" href="../manifest.json">

  <!-- ios support -->
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/icons/icon-96x96.png">
  <meta name="apple-mobile-web-app-status-bar" content="#6c0e7f">
  <meta name="theme-color" content="#9c27b0">


</head>

<body class="" oncontextmenu="return false">
  <div class="wrapper ">
    <div class="sidebar" data-color="purple" data-background-color="white" data-image="../assets/img/sidebar-1.jpg">
      <!--
        Tip 1: You can change the color of the sidebar using: data-color="purple | azure | green | orange | danger"

        Tip 2: you can also add an image using data-image tag
    -->
      <div class="logo"><a href="" class="simple-text logo-normal" onclick="menutoggler()">
          ITRACE
        </a>
      </div>
      <div class="sidebar-wrapper">
        <ul class="nav">
          <li class="nav-item active  ">
            <a class="nav-link" href="dashboard.html">
              <i class="material-icons">dashboard</i>
              <p>Dashboard</p>
            </a>
          </li>
         <!-- <li class="nav-item ">
            <a class="nav-link" href="notifications.html">
              <i class="material-icons">notifications</i>
              <p>Activity</p>
            </a>
          </li> -->
          <li class="nav-item ">
            <a class="nav-link" href="maps.html">
              <i class="material-icons">location_ons</i>
              <p>Check Area</p>
            </a>
          </li>
          
        </ul>

        
      </div>
    </div>
    <div class="main-panel">
      <!-- Navbar -->
      
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="javascript:void(0);">Dashboard</a>
          </div>
          <button id="menutogglerbtn" class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end">
            <!-- <form class="navbar-form">
              <div class="input-group no-border">
                <input type="text" value="" class="form-control" placeholder="Search...">
                <button type="submit" class="btn btn-white btn-round btn-just-icon">
                  <i class="material-icons">search</i>
                  <div class="ripple-container"></div>
                </button>
              </div>
            </form> -->
            <ul class="navbar-nav">
              
            </ul>
          </div>
        </div>
        <hr/>
      </nav>
      <!-- End Navbar -->

      <!-- main content -->
      <div class="content">
        <div class="container-fluid">
          <!-- <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats">
                <div class="card-header card-header-warning card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">content_copy</i>
                  </div>
                  <p class="card-category">Used Space</p>
                  <h3 class="card-title">49/50
                    <small>GB</small>
                  </h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <i class="material-icons text-danger">warning</i>
                    <a href="javascript:;">Get More Space...</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats">
                <div class="card-header card-header-success card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">store</i>
                  </div>
                  <p class="card-category">Revenue</p>
                  <h3 class="card-title">$34,245</h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <i class="material-icons">date_range</i> Last 24 Hours
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats">
                <div class="card-header card-header-danger card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">info_outline</i>
                  </div>
                  <p class="card-category">Fixed Issues</p>
                  <h3 class="card-title">75</h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <i class="material-icons">local_offer</i> Tracked from Github
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats">
                <div class="card-header card-header-info card-header-icon">
                  <div class="card-icon">
                    <i class="fa fa-twitter"></i>
                  </div>
                  <p class="card-category">Followers</p>
                  <h3 class="card-title">+245</h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <i class="material-icons">update</i> Just Updated
                  </div>
                </div>
              </div>
            </div>
          </div> -->

          <div class="row">

            
            <div class="col-md-4">
              <div class="card card-chart">
                <div class="card-header card-header-success" >
                  <div class="ct-chart" id="recoveryChartdiv"></div>
                </div>
                <div class="card-body">
                  <!-- <div class="card-actions"> 
                    <a href="" class="btn btn-info btn-link" rel="tooltip" data-placement="bottom" title="Refresh">
                      <i class="material-icons">refresh</i>
                    </a>
                    <a href="recovery.html" class="btn btn-default btn-link" rel="tooltip" data-placement="bottom" title="See more">
                      <i class="material-icons">visibility</i>
                    </a>
                  </div> -->
                  <h4 class="card-title">Recovery Cases</h4>
                  <p class="card-category" id="r_cases_p">
                    
                  </p>
                </div>
                <div class="card-footer">
                  <div class="stats" id="updaterelativetime_recovery">
                    <i class="material-icons">access_time</i> updated 
                  </div>
                </div>
              </div>
            </div>
        
            <div class="col-md-4">
              
              <div class="card card-chart">
                <div class="card-header card-header-warning">
                  <div class="ct-chart" id="infectedChartdiv"></div>
                </div>
                <div class="card-body">
                 
                  <h4 class="card-title">Infected Cases</h4>
                  <p class="card-category" id="i_cases_p">
                   
                  </p>
                </div>
                <div class="card-footer">
                  <div class="stats" id="updaterelativetime_infected">
                    <i class="material-icons">access_time</i> updated 
                  </div>
                </div>
              </div>
            </div>


            <div class="col-md-4">
              <div class="card card-chart">
                <div class="card-header card-header-danger">
                  <div class="ct-chart" id="deathChartdiv"></div>
                </div>
                <div class="card-body">
                  
                  <h4 class="card-title">Death Rates</h4>
                  <p class="card-category" id="d_cases_p">
                     
                  </p>
                </div>
                <div class="card-footer">
                  <div class="stats" id="updaterelativetime_death">
                    <i class="material-icons">access_time</i> updated 
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
      <!-- main content  -->


    </div>
  </div>

  <!-- customizer sidebar -->
  

  
  <!--   Core JS Files   -->
  <script src="../assets/js/core/jquery.min.js"></script>
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap-material-design.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <!-- Plugin for the momentJs  -->
  <script src="../assets/js/plugins/moment.min.js"></script>
  <!--  Plugin for Sweet Alert -->
  <script src="../assets/js/plugins/sweetalert2.js"></script>
  <!-- Forms Validations Plugin -->
  <script src="../assets/js/plugins/jquery.validate.min.js"></script>
  <!-- Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
  <script src="../assets/js/plugins/jquery.bootstrap-wizard.js"></script>
  <!--	Plugin for Select, full documentation here: http://silviomoreto.github.io/bootstrap-select -->
  <script src="../assets/js/plugins/bootstrap-selectpicker.js"></script>
  <!--  Plugin for the DateTimePicker, full documentation here: https://eonasdan.github.io/bootstrap-datetimepicker/ -->
  <script src="../assets/js/plugins/bootstrap-datetimepicker.min.js"></script>
  <!--  DataTables.net Plugin, full documentation here: https://datatables.net/  -->
  <script src="../assets/js/plugins/jquery.dataTables.min.js"></script>
  <!--	Plugin for Tags, full documentation here: https://github.com/bootstrap-tagsinput/bootstrap-tagsinputs  -->
  <script src="../assets/js/plugins/bootstrap-tagsinput.js"></script>
  <!-- Plugin for Fileupload, full documentation here: http://www.jasny.net/bootstrap/javascript/#fileinput -->
  <script src="../assets/js/plugins/jasny-bootstrap.min.js"></script>
  <!--  Full Calendar Plugin, full documentation here: https://github.com/fullcalendar/fullcalendar    -->
  <script src="../assets/js/plugins/fullcalendar.min.js"></script>
  <!-- Vector Map plugin, full documentation here: http://jvectormap.com/documentation/ -->
  <script src="../assets/js/plugins/jquery-jvectormap.js"></script>
  <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
  <script src="../assets/js/plugins/nouislider.min.js"></script>
  <!-- Include a polyfill for ES6 Promises (optional) for IE11, UC Browser and Android browser support SweetAlert -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.js"></script>
  <!-- Library for adding dinamically elements -->
  <script src="../assets/js/plugins/arrive.min.js"></script>
  <!--  Google Maps Plugin    -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCL0GSMCN9vKb6AUulcxHsLEj3JQHVJS9M"></script>
  <!-- Chartist JS -->
  <script src="../assets/js/plugins/chartist.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="../assets/js/plugins/bootstrap-notify.js"></script>
  <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../assets/js/material-dashboard.js?v=2.1.2" type="text/javascript"></script>
  <!-- Material Dashboard DEMO methods, don't include it in your project! -->
  <script src="../assets/js/main.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-firestore.js"></script>
  <script src="../assets/js/app.js"></script>
  <script src="../assets/js/swalfire.js"></script>
  <script src="../assets/js/fstore.js"></script>
  <script src="../assets/js/session.js"></script>
  <script src="../assets/js/charts.js"></script>
   
  <script>
    $(document).ready(function() {
      // Javascript method's body can be found in ../assets/js/demos.js
      // md.initDashboardPageCharts();
      chart.recoveryChart();
      chart.infectedChart();
      chart.deathChart();
      session.initSession();        

      let r_case = [], i_case = [], d_case = [], r_case_new = [], i_case_new = [], d_case_new = []

      let today = new Date().getTime();
      db.collection("trace_record").orderBy('time_added', 'desc').limit(1).onSnapshot((snapshot) => {
        snapshot.docChanges().forEach(data => { 
          timediff(data.doc.data(), today)          
        })
        
      })

      db.collection("trace_record").orderBy('time_added', 'desc').onSnapshot((snapshot) => {
        snapshot.docChanges().forEach(data => { 
          const convertfireBaseTime = new Date(
              data.doc.data().time_added.seconds * 1000 + data.doc.data().time_added.nanoseconds / 1000000,
          );
          function timeConverter(convertfireBaseTime){
            var a = new Date(convertfireBaseTime);
            var abbrmonths = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            var fullmonths = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            var year = a.getFullYear();
            var month = abbrmonths[a.getMonth()];
            var date = a.getDate();
            var hour = a.getHours();
            var min = a.getMinutes();
            var sec = a.getSeconds();      
            var finalformat = a.getMonth() + '/' + date + '/' + year;
            return finalformat;
          }
          if(data.doc.data().type == "Recovery"){
            r_case.push(data.doc.data());
            if(timeConverter(convertfireBaseTime) == timeConverter(today)){
              r_case_new.push(data.doc.data());
            }
          }
          if(data.doc.data().type == "Infected"){
            i_case.push(data.doc.data());
            if(timeConverter(convertfireBaseTime) == timeConverter(today)){
              i_case_new.push(data.doc.data());
            }
          }
          if(data.doc.data().type == "Death"){
            d_case.push(data.doc.data());
            if(timeConverter(convertfireBaseTime) == timeConverter(today)){
              d_case_new.push(data.doc.data());
            }
          }
      
        })

        const r_case_content = `
            <span class="text-success" id="r_cases_p"><i class="fa fa-long-arrow-up"></i> ${r_case_new.length} </span> New ${with_s()} in total of ${r_case.length} recovery cases.
          `
          const i_case_content = `
            <span class="text-warning" id="r_cases_p"><i class="fa fa-long-arrow-up"></i> ${i_case_new.length} </span> New ${with_s()} in total of ${i_case.length} infected cases.
          `
          const d_case_content = `
            <span class="text-danger" id="r_cases_p"><i class="fa fa-long-arrow-up"></i> ${d_case_new.length} </span> New ${with_s()} in total of ${d_case.length} death cases.
          `
          function with_s(){
            if(r_case_new.length == 1 || i_case_new.length == 1 || d_case_new.length == 1){
              return "case"
            }else{
              return "cases"
            }
          }
          $('#r_cases_p').html(r_case_content);
          $('#i_cases_p').html(i_case_content);
          $('#d_cases_p').html(d_case_content);
          console.log("r cases: "+ r_case.length + " new " + r_case_new.length)
          console.log("i cases: "+ i_case.length + " new " + i_case_new.length)
          console.log("d cases: "+ d_case.length + " new " + d_case_new.length)      

      })

      
      function timediff(data, today) {
        const convertfireBaseTime = new Date(
              data.time_added.seconds * 1000 + data.time_added.nanoseconds / 1000000,
            );
            console.log(timeConverter(today))
            console.log(timeConverter(convertfireBaseTime))
            var timetoday = [];
            var timefirebase = [];
            for (var i=0; i<6; i++) {                
                timetoday.push(timeConverter(today)[i])
                timefirebase.push(timeConverter(convertfireBaseTime)[i])
            }        
            var today_a = timeConverter(today)[0].toString()
            var today_b = timeConverter(today)[1].toString()
            var today_c = timeConverter(today)[2].toString()
            var today_d = timeConverter(today)[3].toString()
            var today_e = timeConverter(today)[4].toString()
            var today_f = timeConverter(today)[5].toString()

            var previous_a = timeConverter(convertfireBaseTime)[0].toString()
            var previous_b = timeConverter(convertfireBaseTime)[1].toString()
            var previous_c = timeConverter(convertfireBaseTime)[2].toString()
            var previous_d = timeConverter(convertfireBaseTime)[3].toString()
            var previous_e = timeConverter(convertfireBaseTime)[4].toString()
            var previous_f = timeConverter(convertfireBaseTime)[5].toString()
            
            var current = new Date(today_a, today_b, today_c, today_d, today_e, today_f)
            var previous = new Date(previous_a, previous_b, previous_c, previous_d, previous_e, previous_f)
            // console.log(current)
            // console.log(previous)
            // console.log(relativetimeDifference(current, previous))
            $('#updaterelativetime_recovery').html('<i class="material-icons">access_time</i> updated '+ relativetimeDifference(current,previous))
            $('#updaterelativetime_infected').html('<i class="material-icons">access_time</i> updated '+ relativetimeDifference(current,previous))
            $('#updaterelativetime_death').html('<i class="material-icons">access_time</i> updated '+ relativetimeDifference(current,previous))
      }
      
 
  
      function relativetimeDifference(current, previous) {
    
          var msPerMinute = 60 * 1000;
          var msPerHour = msPerMinute * 60;
          var msPerDay = msPerHour * 24;
          var msPerMonth = msPerDay * 30;
          var msPerYear = msPerDay * 365;
          
          var elapsed = current - previous;
          
          if (elapsed < msPerMinute) {
              return Math.round(elapsed/1000) + ' seconds ago';   
          }
          
          else if (elapsed < msPerHour) {
              return Math.round(elapsed/msPerMinute) + ' minutes ago';   
          }
          
          else if (elapsed < msPerDay ) {
              return Math.round(elapsed/msPerHour ) + ' hours ago';   
          }

          else if (elapsed < msPerMonth) {
              return 'approximately ' + Math.round(elapsed/msPerDay) + ' days ago';   
          }
          
          else if (elapsed < msPerYear) {
              return 'approximately ' + Math.round(elapsed/msPerMonth) + ' months ago';   
          }
          
          else {
              return 'approximately ' + Math.round(elapsed/msPerYear ) + ' years ago';   
          }
      }

      function timeConverter(convertfireBaseTime){
          var a = new Date(convertfireBaseTime);
          var year = a.getFullYear();
          var month = a.getMonth();
          var date = a.getDate();
          var hour = a.getHours();
          var min = a.getMinutes();
          var sec = a.getSeconds();
              // if()
          var finalformat_r = [] 
          finalformat_r.push(year);
          finalformat_r.push(month);
          finalformat_r.push(date);
          finalformat_r.push(hour);
          finalformat_r.push(min);
          finalformat_r.push(sec);          
          return (finalformat_r);
      }

      
    });

    
  </script>
</body>

</html>